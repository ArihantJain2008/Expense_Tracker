<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f9f9f9;
      padding: 20px;
    }
    h2 {
      margin-bottom: 20px;
    }
    canvas {
      max-width: 600px;
      margin: auto;
    }
    .filters {
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    select {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    a {
      display: inline-block;
      margin-top: 20px;
      text-decoration: none;
      color: white;
      background: #222E9B;
      padding: 10px 20px;
      border-radius: 8px;
    }
    a:hover {
      background: #1a227a;
    }
    #noDataMsg {
      margin-top: 40px;
      font-size: 18px;
      color: #555;
    }
    #compareBtn {
      margin-top: 20px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: #222E9B;
      color: white;
      cursor: pointer;
    }
    #compareBtn:hover {
      background: #1a227a;
    }
    #compareResult {
      margin-top: 15px;
      font-size: 16px;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>Spending Report</h2>

  <div class="filters">
    <select id="yearFilter"></select>
    <select id="monthFilter">
      <option value="All">All Months</option>
      <option value="January">January</option>
      <option value="February">February</option>
      <option value="March">March</option>
      <option value="April">April</option>
      <option value="May">May</option>
      <option value="June">June</option>
      <option value="July">July</option>
      <option value="August">August</option>
      <option value="September">September</option>
      <option value="October">October</option>
      <option value="November">November</option>
      <option value="December">December</option>
    </select>
    <select id="dayFilter"></select>
  </div>

  <canvas id="categoryChart"></canvas>
  <div id="noDataMsg" style="display:none;">No transactions available for the selected filters.</div>

  <button id="compareBtn">Compare with Previous Month</button>
  <div id="compareResult"></div>

  <script>
    // ---------- Load or Initialize Data ----------
    let saved = localStorage.getItem("expenseData");
    let data = saved ? JSON.parse(saved) : {};

    if (!saved || Object.keys(data).length === 0) {
      const testData = {
        "January": {
          "transactions": [
            { "desc": "Food", "amount": 500, "day": 5, "month": "January", "year": 2025 },
            { "desc": "Transport", "amount": 200, "day": 6, "month": "January", "year": 2025 },
            { "desc": "Entertainment", "amount": 300, "day": 7, "month": "January", "year": 2025 }
          ]
        },
        "February": {
          "transactions": [
            { "desc": "Food", "amount": 400, "day": 2, "month": "February", "year": 2025 }
          ]
        }
      };
      localStorage.setItem("expenseData", JSON.stringify(testData));
      data = testData;
    }

    const yearFilter = document.getElementById("yearFilter");
    const monthFilter = document.getElementById("monthFilter");
    const dayFilter = document.getElementById("dayFilter");
    const noDataMsg = document.getElementById("noDataMsg");
    const compareBtn = document.getElementById("compareBtn");
    const compareResult = document.getElementById("compareResult");
    let chart;

    // ---------- Populate Years ----------
    function populateYears() {
      const currentYear = new Date().getFullYear();
      let options = '<option value="All">All</option>';
      for (let y = 2000; y <= currentYear; y++) {
        options += `<option value="${y}">${y}</option>`;
      }
      yearFilter.innerHTML = options;
      yearFilter.value = "All";
    }

    // ---------- Populate Days ----------
    function populateDays() {
      let options = '<option value="All">All</option>';
      for (let d = 1; d <= 31; d++) {
        options += `<option value="${d}">${d}</option>`;
      }
      dayFilter.innerHTML = options;
      dayFilter.value = "All";
    }

    // ---------- Filter Transactions ----------
    function getFilteredTransactions() {
      let transactions = [];
      for (let month in data) {
        if (!data[month].transactions) continue;
        data[month].transactions.forEach(t => {
          let match = true;
          if (yearFilter.value !== "All" && t.year != yearFilter.value) match = false;
          if (monthFilter.value !== "All" && t.month !== monthFilter.value) match = false;
          if (dayFilter.value !== "All" && t.day != dayFilter.value) match = false;
          if (match) transactions.push(t);
        });
      }
      return transactions;
    }

    // ---------- Update Chart ----------
    function updateChart() {
      const transactions = getFilteredTransactions();
      if (transactions.length === 0) {
        if (chart) chart.destroy();
        noDataMsg.style.display = "block";
        return;
      } else {
        noDataMsg.style.display = "none";
      }

      let categoryTotals = {};
      transactions.forEach(t => {
        if (!categoryTotals[t.desc]) categoryTotals[t.desc] = 0;
        categoryTotals[t.desc] += t.amount;
      });

      const ctx = document.getElementById("categoryChart").getContext("2d");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: Object.keys(categoryTotals),
          datasets: [{
            label: "Total Spent",
            data: Object.values(categoryTotals),
            backgroundColor: [
              "#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0",
              "#9966FF", "#FF9F40", "#2ECC71", "#E67E22"
            ],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            title: {
              display: true,
              text: "Spending by Category"
            }
          }
        }
      });
    }

    // ---------- Compare with Previous Month ----------
    function compareWithPrevious() {
      const monthsOrder = [
        "January","February","March","April","May","June",
        "July","August","September","October","November","December"
      ];

      const selectedMonth = monthFilter.value;
      if (selectedMonth === "All") {
        compareResult.innerHTML = "<p>Please select a month to compare.</p>";
        return;
      }

      const selectedIndex = monthsOrder.indexOf(selectedMonth);
      if (selectedIndex <= 0) {
        compareResult.innerHTML = "<p>No previous month available to compare.</p>";
        return;
      }

      const prevMonth = monthsOrder[selectedIndex - 1];
      const selectedData = data[selectedMonth]?.transactions || [];
      const prevData = data[prevMonth]?.transactions || [];

      const selectedTotal = selectedData.reduce((sum, t) => sum + t.amount, 0);
      const prevTotal = prevData.reduce((sum, t) => sum + t.amount, 0);

      if (selectedTotal === 0 && prevTotal === 0) {
        compareResult.innerHTML = "<p>No data available for comparison.</p>";
        return;
      }

      const diff = selectedTotal - prevTotal;
      const percentage = prevTotal > 0 ? ((diff / prevTotal) * 100).toFixed(2) : "N/A";

      compareResult.innerHTML = `
        <h3>ðŸ“Š Comparison</h3>
        <p>${prevMonth}: â‚¹${prevTotal}</p>
        <p>${selectedMonth}: â‚¹${selectedTotal}</p>
        <p style="color:${diff > 0 ? 'red' : 'green'};">
          ${diff > 0 ? "â†‘ Spent more" : "â†“ Spent less"} by â‚¹${Math.abs(diff)} (${percentage}%)
        </p>
      `;
    }

    // ---------- Event Listeners ----------
    yearFilter.addEventListener("change", updateChart);
    monthFilter.addEventListener("change", updateChart);
    dayFilter.addEventListener("change", updateChart);
    compareBtn.addEventListener("click", compareWithPrevious);

    // ---------- Initialize ----------
    populateYears();
    populateDays();
    updateChart();
  </script>

  <footer>
    <div class="report">
      <a href="index.html"><button type="button"><i class="fa-solid fa-house"></i></button></a>
      <a href="report.html"><button type="button"><i class="fa-solid fa-chart-column"></i></button></a>
      <a href="badge.html"><button type="button"><i class="fa-solid fa-ribbon"></i></button></a>
      <a href="savings.html"><button type="button"><i class="fa-solid fa-piggy-bank"></i></button></a>
    </div>
  </footer>
</body>
</html>
